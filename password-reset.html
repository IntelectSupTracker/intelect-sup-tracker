<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset your password — Sup Tracker</title>

  <!-- Minimal pastel theme -->
  <style>
    :root{
      --bg: #f6fbfb;
      --card: linear-gradient(135deg,#e6f8f7,#eef7ff 50%,#f1f7ff 70%);
      --accent1:#9fe7e0;  /* pastel teal */
      --accent2:#b6d7ff;  /* pastel blue */
      --accent3:#d8c1ff;  /* pastel purple */
      --accent4:#c8f4c7;  /* pastel green */
      --muted:#6b6f77;
      --white: #ffffff;
      --radius:14px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(159,231,224,0.18), transparent 8%),
                  radial-gradient(900px 500px at 90% 90%, rgba(200,244,199,0.12), transparent 8%),
                  var(--bg);
      padding:24px;
      color:var(--muted);
    }

    .container{
      width:100%;
      max-width:520px;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow: 0 10px 30px rgba(20,30,40,0.08);
      padding:28px;
      border: 1px solid rgba(120,140,160,0.06);
    }

    h1{
      margin:0 0 6px 0;
      font-size:20px;
      color:#213240;
    }
    p.lead{ margin:0 0 18px 0; color: #4a5560; font-size:14px; }

    .status{
      font-size:13px;
      margin-bottom:12px;
      min-height:18px;
    }

    .card{
      background: rgba(255,255,255,0.72);
      border-radius:10px;
      padding:14px;
      border: 1px solid rgba(120,140,160,0.04);
      margin-bottom:12px;
    }

    label{ font-size:13px; color:#344154; display:block; margin-bottom:8px; }
    input[type="password"]{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid rgba(60,80,100,0.08);
      outline:none;
      font-size:14px;
      background:transparent;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      margin-top:12px;
      padding:10px 14px;
      font-weight:600;
      border-radius:10px;
      border:none;
      cursor:pointer;
      transition:transform .06s ease;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color: #06202a;
      box-shadow: 0 6px 18px rgba(60,110,130,0.08);
    }
    .btn:active{ transform:translateY(1px); }
    .btn.secondary{
      background: linear-gradient(90deg, var(--accent3), var(--accent4));
      color:#132028;
    }

    .note{ font-size:12px; color:#556170; margin-top:8px; }

    .small {
      font-size:12px;
      color:#426b75;
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:center;
    }

    .link {
      color: #0b7180;
      text-decoration:underline;
      cursor:pointer;
    }

    footer{ font-size:12px; color:#a0a7ad; margin-top:16px; text-align:center; }
  </style>
</head>
<body>
  <div class="container" role="main">
    <h1>Reset your password</h1>
    <p class="lead">Enter a new password for your Sup Tracker account. This page is linked to your project and will update the real Supabase account.</p>

    <div id="status" class="status" aria-live="polite"></div>

    <div id="formWrap" class="card" hidden>
      <label for="password">New password</label>
      <input id="password" type="password" placeholder="minimum 6 characters" autocomplete="new-password" />
      <label for="confirm" style="margin-top:10px">Confirm password</label>
      <input id="confirm" type="password" placeholder="re-type new password" autocomplete="new-password" />
      <div style="display:flex;gap:10px;">
        <button id="submitBtn" class="btn">Set new password</button>
        <button id="cancelBtn" class="btn secondary" type="button">Cancel</button>
      </div>
      <div class="note">Tip: Use a strong password. Passwords are sent to Supabase over HTTPS.</div>
    </div>

    <div id="noToken" class="card" hidden>
      <p><strong>We couldn't find a password reset token in the URL.</strong></p>
      <p class="note">If you clicked the reset link in your email but see this, try copying the full link into the address bar (don't remove the part after the #). If that still fails, request a new reset from your app's login screen.</p>
      <div style="display:flex;gap:10px;margin-top:8px;">
        <a id="openLogin" class="link">Open login page</a>
      </div>
    </div>

    <footer>Sup Tracker — Password Reset</footer>
  </div>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>

  <script>
    (function () {
      // ==== CONFIGURE THESE ====
      // Replace with your Supabase project public URL and anon key
      const SUPABASE_URL = "https://pfoovfknmamxhznrceot.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmb292ZmtubWFteGh6bnJjZW90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjU4NTEsImV4cCI6MjA3ODcwMTg1MX0.7lmLmX_6V7Mk9JZfgSSW9Ox2siYqsQerhkyj3mdNIL8";
      // Optional: link back to app login
      const APP_LOGIN_URL = "/"; // update if your hosted app path differs
      // =========================

      // init client
      const supabase = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const statusEl = document.getElementById('status');
      const formWrap = document.getElementById('formWrap');
      const noToken = document.getElementById('noToken');
      const pwdEl = document.getElementById('password');
      const confirmEl = document.getElementById('confirm');
      const submitBtn = document.getElementById('submitBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      document.getElementById('openLogin').addEventListener('click', ()=> location.href = APP_LOGIN_URL);

      // Utilities: read hash (after #) and query params
      function parseHash(hash) {
        // hash may look like: #access_token=...&type=recovery&...
        const cleaned = hash.replace(/^#/, '');
        const parts = cleaned.split('&').filter(Boolean);
        const obj = {};
        for (const p of parts) {
          const [k, v] = p.split('=');
          if (k) obj[decodeURIComponent(k)] = v ? decodeURIComponent(v) : '';
        }
        return obj;
      }

      function showStatus(text, isError=false) {
        statusEl.textContent = text;
        statusEl.style.color = isError ? '#cc3f3f' : '#2f6b72';
      }

      async function handleTokenFlow() {
        showStatus('Checking reset token…');

        // 1) Look for tokens in hash (supabase usually returns access_token in hash)
        const hashObj = parseHash(window.location.hash || '');
        let access_token = hashObj.access_token || hashObj['access-token'] || '';
        let refresh_token = hashObj.refresh_token || '';

        // 2) As fallback, check query string too
        if (!access_token) {
          const qp = new URLSearchParams(window.location.search);
          access_token = qp.get('access_token') || qp.get('token') || '';
          if (!refresh_token) refresh_token = qp.get('refresh_token') || '';
        }

        if (!access_token) {
          // no token: show instructions
          showStatus('');
          noToken.hidden = false;
          formWrap.hidden = true;
          return;
        }

        // show UI
        showStatus('Valid reset token found — enter a new password below.');
        noToken.hidden = true;
        formWrap.hidden = false;

        // When user submits new password:
        submitBtn.addEventListener('click', async () => {
          const p = pwdEl.value.trim();
          const c = confirmEl.value.trim();
          if (p.length < 6) {
            showStatus('Password must be at least 6 characters.', true);
            return;
          }
          if (p !== c) {
            showStatus('Passwords do not match.', true);
            return;
          }

          submitBtn.disabled = true;
          submitBtn.textContent = 'Updating…';

          try {
            // IMPORTANT: set session from access_token so supabase client is authorized
            // Supabase JS v2: setSession API sets both tokens - we pass what we have.
            if (typeof supabase.auth.setSession === 'function') {
              await supabase.auth.setSession({ access_token, refresh_token });
            } else if (typeof supabase.auth.setAuth === 'function') {
              // older client fallback
              supabase.auth.setAuth(access_token);
            }

            // Now call updateUser to set the new password
            const { data, error } = await supabase.auth.updateUser({ password: p });

            if (error) {
              console.error(error);
              showStatus('Failed to update password: ' + (error.message || JSON.stringify(error)), true);
              submitBtn.disabled = false;
              submitBtn.textContent = 'Set new password';
              return;
            }

            // success
            showStatus('Password updated successfully — you are now signed in. Redirecting to app…');
            // small delay so user sees message, then redirect
            setTimeout(() => {
              location.href = APP_LOGIN_URL;
            }, 1300);

          } catch (err) {
            console.error(err);
            showStatus('Unexpected error updating password. Check console.', true);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Set new password';
          }
        });

        cancelBtn.addEventListener('click', ()=> {
          // clear tokens from URL for security and show login
          history.replaceState(null, '', window.location.pathname);
          location.href = APP_LOGIN_URL;
        });
      }

      // Start
      // Small timeout so UI paints quickly
      setTimeout(handleTokenFlow, 250);
    })();
  </script>
</body>
</html>
